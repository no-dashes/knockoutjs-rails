!function(e,t){"function"==typeof define&&define.amd?define(["knockout"],t):"object"==typeof exports?module.exports=t(require("knockout")):e.KnockoutFastForeach=t(e.ko)}(this,function(e){"use strict";function t(e){return!!e&&"object"==typeof e&&e.constructor===Object}function n(e){return 8===e.nodeType&&h.test(u?e.text:e.nodeValue)}function s(t){var n,s=document.createElement("div");return t.content?n=t.content:"SCRIPT"===t.tagName?(n=document.createElement("div"),n.innerHTML=t.text):n=t,e.utils.arrayForEach(e.virtualElements.childNodes(n),function(e){e&&s.insertBefore(e.cloneNode(!0),null)}),s}function i(e,t){return{status:"added",value:e,index:t}}function o(e,t){var n=t[e],s=t[e-1];if(0===e||e>=t.length||"added"!==n.status)return!1;if("added"===s.status&&s.index===n.index-1)return!0;var i=t[e-2];return i&&"deleted"===s.status&&s.index===n.index&&"added"===i.status&&i.index===n.index-1?!0:!1}function a(t){this.element=t.element,this.container=n(this.element)?this.element.parentNode:this.element,this.$context=t.$context,this.data=t.data,this.as=t.as,this.noContext=t.noContext,this.noIndex=t.noIndex,this.afterAdd=t.afterAdd,this.beforeRemove=t.beforeRemove,this.templateNode=s(t.name?document.getElementById(t.name).cloneNode(!0):t.element),this.afterQueueFlush=t.afterQueueFlush,this.beforeQueueFlush=t.beforeQueueFlush,this.changeQueue=[],this.lastNodesList=[],this.indexesToDelete=[],this.rendering_queued=!1,e.virtualElements.emptyNode(this.element);var o=e.unwrap(this.data);o.map&&this.onArrayChange(o.map(i)),e.isObservable(this.data)&&(this.data.indexOf||(this.data=this.data.extend({trackArrayChanges:!0})),this.changeSubs=this.data.subscribe(this.onArrayChange,this,"arrayChange"))}function r(t){t.$index=e.observable()}var d=9007199254740991,u=document&&"<!--test-->"===document.createComment("test").text,h=u?/^<!--\s*ko(?:\s+([\s\S]+))?\s*-->$/:/^\s*ko(?:\s+([\s\S]+))?\s*$/,l=document&&"function"==typeof document.createDocumentFragment;a.animateFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||function(e){return window.setTimeout(e,1e3/60)},a.prototype.dispose=function(){this.changeSubs&&this.changeSubs.dispose()},a.prototype.onArrayChange=function(e){for(var t=this,n={added:[],deleted:[]},s=0,i=e.length;i>s;s++)if(o(s,e)){var r=n.added[n.added.length-1].values;if(!r){var d=n.added.pop(),u={isBatch:!0,status:"added",index:d.index,values:[d.value]};r=u.values,n.added.push(u)}r.push(e[s].value)}else n[e[s].status].push(e[s]);n.deleted.length>0&&(this.changeQueue.push.apply(this.changeQueue,n.deleted),this.changeQueue.push({status:"clearDeletedIndexes"})),this.changeQueue.push.apply(this.changeQueue,n.added),this.changeQueue.length>0&&!this.rendering_queued&&(this.rendering_queued=!0,a.animateFrame.call(window,function(){t.processQueue()}))},a.prototype.processQueue=function(){var t=this,n=d;"function"==typeof this.beforeQueueFlush&&this.beforeQueueFlush(this.changeQueue),e.utils.arrayForEach(this.changeQueue,function(e){"number"==typeof e.index&&(n=Math.min(n,e.index)),t[e.status](e)}),this.rendering_queued=!1,this.noIndex||this.updateIndexes(n),"function"==typeof this.afterQueueFlush&&this.afterQueueFlush(this.changeQueue),this.changeQueue=[]},a.prototype.added=function(t){for(var n=t.index,s=t.isBatch?t.values:[t.value],i=this.lastNodesList[n-1]||null,o=[],a=0,d=s.length;d>a;++a){var u,h=this.templateNode.cloneNode(!0);u=this.noContext?this.$context.extend({$item:s[a],$index:this.noIndex?void 0:e.observable()}):this.$context.createChildContext(s[a],this.as||null,this.noIndex?void 0:r),e.applyBindingsToDescendants(u,h);var l=e.virtualElements.childNodes(h);o.push.apply(o,Array.prototype.slice.call(l)),this.lastNodesList.splice(n+a,0,l[l.length-1])}"function"==typeof this.afterAdd?this.afterAdd({nodeOrArrayInserted:this.insertAllAfter(o,i),foreachInstance:this}):this.insertAllAfter(o,i)},a.prototype.insertAllAfter=function(t,n){var s,i,o,a=this.element;if("undefined"!=typeof t.nodeType&&"undefined"==typeof t.length)throw new Error("Expected a single node or a node array");if("undefined"!=typeof t.nodeType)return e.virtualElements.insertAfter(a,t,n),[t];if(1===t.length)e.virtualElements.insertAfter(a,t[0],n);else if(l){for(s=document.createDocumentFragment(),o=0,i=t.length;o!==i;++o)s.appendChild(t[o]);e.virtualElements.insertAfter(a,s,n)}else for(o=t.length-1;o>=0;--o){var r=t[o];if(!r)break;e.virtualElements.insertAfter(a,r,n)}return t},a.prototype.deleted=function(t){var n,s,i=t.index,o=this.lastNodesList[i],a=this.lastNodesList[i-1]||this.element;do o=o.previousSibling,s=o&&o.nextSibling||e.virtualElements.firstChild(this.element),this.beforeRemove&&s?(n=this.beforeRemove({nodeToRemove:s,foreachInstance:this})||{},"function"==typeof n.then&&n.then(function(){e.removeNode(s)},e.onError?e.onError:void 0)):s&&e.removeNode(s);while(o&&o!==a);this.lastNodesList[i]=this.lastNodesList[i-1],this.indexesToDelete.push(i)},a.prototype.clearDeletedIndexes=function(){for(var e=this.indexesToDelete.length-1;e>=0;--e)this.lastNodesList.splice(this.indexesToDelete[e],1);this.indexesToDelete=[]},a.prototype.getContextStartingFrom=function(t){for(var n;t;){if(n=e.contextFor(t))return n;t=t.nextSibling}},a.prototype.updateIndexes=function(t){for(var n,s=t,i=this.lastNodesList.length;i>s;++s)n=this.getContextStartingFrom(0===s?e.virtualElements.childNodes(this.element)[0]:this.lastNodesList[s-1].nextSibling),n&&n.$index(s)},e.bindingHandlers.fastForEach={init:function(n,s,i,o,r){var d,u=s();return t(u)?(u.element=u.element||n,u.$context=r,d=new a(u)):d=new a({element:n,data:e.unwrap(r.$rawData)===u?r.$rawData:u,$context:r}),e.utils.domNodeDisposal.addDisposeCallback(n,function(){d.dispose()}),{controlsDescendantBindings:!0}},FastForEach:a},e.virtualElements.allowedBindings.fastForEach=!0});